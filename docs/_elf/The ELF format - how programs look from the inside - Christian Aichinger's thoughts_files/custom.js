$(function() {
    var images = $('.inner-content img[title], .inner-content iframe');
    images.wrap('<div class="img-container"></div>');

    images.each(function() {
        var img = $(this);
        var title = img.attr('title');
        if (title && title.length > 0) {
            var div = jQuery('<div class="img-caption" />');
            div.html(title);
            img.after(div);
        }
    });
    images.removeAttr('title');


    function post(path, parameters) {
        var form = $('<form class="post-redirect"></form>');

        form.attr("method", "POST");
        form.attr("action", path);
        form.attr("target", "_blank");

        $.each(parameters, function(key, value) {
            var field = $('<input></input>');

            field.attr("type", "hidden");
            field.attr("name", key);
            field.attr("value", value);

            form.append(field);
        });

        // The form needs to be a part of the document in
        // order for us to be able to submit it.
        $(document.body).append(form);
        form.submit();
    }

    $(".add-cppsh-link").parent().next(".highlight").each(function() {
        var pre = $(this).children("pre");
        if (pre.length === 0) {
            return;
        }

        $(this).addClass("cppsh-container");
        pre.before("<div class='cppsh-link btn btn-primary btn-sm'>Run</div>");
    });

    $(".cppsh-link").click(function(evt) {
        var source = $(evt.target).next("pre").text();
        post('http://cpp.sh', { source: source });
    });
});
